{% extends "base.html" %}
{% load staticfiles %}


{% block title %}
Sold today
{% endblock %}

{% block content %}
<!-- Begin Page Content -->
<div class="container-fluid">

	<!-- Page Heading -->
	<div class="mt-4 mb-2 mr-2 ml-2">
		<h1 class="h3 mb-0 text-gray-800">Today</h1>
		<p class="mb-1">今天賣出的表單</p>
	</div>
	<div class="row">
		<div class="col-lg-12">
			<div class="card shadow mb-4 mt-4">
				<div class="card-header py-3">
					<h6 class="m-0 font-weight-bold text-primary">Hình thức bán hàng</h6>
				</div>

                <!-- 售貨的商品ID與客人自動填入 -->
				<script>
					$(function () {
						let Product = [
						{% for n in all_pdtid %}
							"{{ n }}",
						{% endfor %}
						];
						let Customer = [
						{% for n in customer %}
							"{{ n.phone_number }}",
						{% endfor %}
						];
						$("#input_product").typeahead({
							source: Product
						});
						$("#input_phone").typeahead({
							source: Customer
						});
					});
				</script>

				<div class="card-body">
				    <!-- 表單內容 -->
					<form id="sale" class="validate-form" method="POST">
						{% csrf_token %}
						<div class="form-group row">
							<label class="col-sm-2 col-xl-1 col-form-label text-gray-900 text-lg">商品</label>
							<!-- max='618107190088-1' -->
							<div id="div_pdt" class="col-md-6 col-xl-3">
								<input type="text" name="product" id="input_product" class="form-control" placeholder="MA HANG">
							</div>
							<div id="div_color" class="col-md-4 col-xl-2">
							<!-- max = '18690'=>'BI TRANG DEN' -->
								<select name="color" id="input_color" class="form-control text-gray-500" disabled="">
									<option>MAU</option>
								</select>
							</div>
							<div class="offset-md-2 col-md-3 offset-xl-0 col-xl-2">
								<select name="size" id="input_size" class="form-control text-gray-500" disabled="">
									<option>size</option>
								</select>
							</div>
							<div class="col-md-3 col-xl-2">
								<select name="count" id="input_count" class="form-control text-gray-500" disabled="">
									<option>count</option>
								</select>
							</div>
							<div class="col-md-4 col-xl-2">
								<input type="number" name="price" id="input_price" class="form-control" placeholder="GIA">
							</div>
						</div>
						<div class="row">

							<label for="" class="col-md-3 col-xl-1 col-form-label text-gray-900 text-lg">客人電話</label>
							<div class="col-md-9 col-xl-3">
								<input type="tel" name="phone" id="input_phone" class="form-control">
							</div>
							<label for="input_clerk" class="col-md-3 col-xl-1 col-form-label text-gray-900 text-lg">店員</label><div class="col">
								<select name="clerk" id="input_clerk" class="col form-control">

									<option>aaa</option>

								</select>
							</div><div class="col-sm-auto">
								<button type="reset" class="col-12 btn btn-secondary">Clear</button>
							</div>
							<div class="col-sm-auto">
								<input type="submit" name="submit" class="col-12 btn btn-primary" value="Submit">
							</div>
						</div>

					</form>

				</div>
			</div>
		</div>
	</div>

    <!-- 換貨區 -->
	<div class="row">
		<div class="col-lg-12">
			<div class="card shadow mb-4">
				<!-- Card Header - Accordion -->
				<a href="#return" class="d-block card-header py-3 collapsed" data-toggle="collapse" role="button" aria-expanded="false" aria-controls="collapseCardExample">
				<h6 class="m-0 font-weight-bold text-gray-600">退換貨</h6>
				</a>

                <!-- 換貨的商品ID自動填入 -->
				<script>
					$(function () {
                        let reProduct = [
						{% for n in sold_pdtid %}
							"{{ n }}",
						{% endfor %}
						];
						$("#return_product").typeahead({
							source: reProduct
						});
					});
				</script>

				<!-- Card Content - Collapse -->
				<div class="collapse card-body" id="return" style="">
					<form class="validate-form" method="POST">
						{% csrf_token %}
						<div class="form-group row">
                            <div class="col-lg-5">
                                <div class="row">
                                    <label class="col-sm-2 col-lg-3 col-xl-2 col-form-label text-gray-900 text-lg">商品</label>
                                    <!-- max='618107190088-1' -->
                                    <div class="col-sm-8 col-lg-6 col-xl-8">
                                        <input type="text" name="product" id="return_product" class="form-control"
                                            placeholder="MA HANG">
                                    </div>
                                    <div class="col-sm-2 col-lg-3 col-xl-2">
                                        <input type="submit" name="submit" class="btn btn-primary" value="搜尋">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-7">
                                <div class="row">
                                    <label for="" class="col-sm-3 col-lg-3 col-xl-2 col-form-label text-gray-900 text-lg">客人電話</label>
                                    <div class="col-sm-7 col-lg-6 col-xl-8">
                                        <input type="tel" name="phone" id="returnphone" class="form-control">
                                    </div>
                                    <div class="col-sm-2 col-lg-3 col-xl-2">
                                        <input type="submit" name="submit" class="btn btn-primary" value="搜尋">
                                    </div>
                                </div>
                            </div>
						</div>

					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-lg-12">
			<div class="card shadow mb-4">
				<!-- Card 標題-->
				<div class="card-header py-3 ">
					<h6 class="m-0 font-weight-bold text-primary">Ghi lại</h6>
					<!-- Modal -->
					<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- Card 內容 -->
				<div class="card-body">
					<table class="table table-bordered table-hover">
						<thead>
							<tr>
								<th scope="col">#</th>
								<th scope="col">MA HANG</th>
								<th scope="col">kích thước</th>
								<th scope="col">Màu</th>
								<th scope="col">Số lượng</th>
								<th scope="col">原價</th>
								<th scope="col">Tổng giá bán</th>
								<th scope="col">Điện thoại</th>
								<th scope="col">店員</th>
								<th scope="col" class="text-danger" style="width: 3rem;">Xóa</th>
							</tr>
						</thead>

						<tbody>

							<tr>
								<td>1</td>
								<td>0068</td>
								<td>27</td>
								<td>XANH</td>
								<td>1</td>
								<td>340</td>
								<td>644</td>
								<td></td>
								<td>aaa</td>
								<td><a href="" name="1" class="delete btn btn-danger btn-circle "><i class="fas fa-trash"></i></a></td>
							</tr>

							<tr>
								<td>2</td>
								<td>A1139</td>
								<td>29</td>
								<td>DEN</td>
								<td>1</td>
								<td>450</td>
								<td>110</td>
								<td>55668877</td>
								<td>aaa</td>
								<td><a href="" name="2" class="delete btn btn-danger btn-circle "><i class="fas fa-trash"></i></a></td>
							</tr>

							<tr>
								<td>3</td>
								<td>18A1066</td>
								<td>27</td>
								<td>NAU</td>
								<td>1</td>
								<td>270</td>
								<td>230</td>
								<td></td>
								<td>aaa</td>
								<td><a href="" name="3" class="delete btn btn-danger btn-circle "><i class="fas fa-trash"></i></a></td>
							</tr>


						</tbody>

					</table>
				</div>
			</div>
		</div>
	</div>


	<div class="row">

		<!-- Earnings (Monthly) Card Example -->
		<div class="col-xl-3 col-md-6 mt-4 mb-2">
			<div class="card border-left-primary shadow h-100 py-2">
				<div class="card-body">
					<div class="row no-gutters align-items-center">
						<div class="col mr-2">
							<div class="text-xs font-weight-bold text-primary text-uppercase mb-1">總數 (件)</div>
							<div class="h5 mb-0 font-weight-bold text-gray-800">3</div>
						</div>
						<div class="col-auto">
							<i class="fas fa-check fa-2x text-gray-300"></i>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Earnings (Monthly) Card Example -->
		<div class="col-xl-3 col-md-6 mt-4 mb-2">
			<div class="card border-left-success shadow h-100 py-2">
				<div class="card-body">
					<div class="row no-gutters align-items-center">
						<div class="col mr-2">
							<div class="text-xs font-weight-bold text-success text-uppercase mb-1">
								總金額 (K)</div>
							<div class="h5 mb-0 font-weight-bold text-gray-800">$984</div>
						</div>
						<div class="col-auto">
							<i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
						</div>
					</div>
				</div>
			</div>
		</div>

    </div>

    <div class="row mt-3 mr-0 mb-5 ml-0">
        <a href="#" class="col-12 btn btn-primary btn-icon-split btn-lg">
            <span class="icon text-white-50">
                <i class="fas fa-arrow-right"></i>
            </span>
            <span class="text">確認送出</span>
        </a>
    </div>


</div>

<script>$.ajaxSetup({headers: {"X-CSRFToken": '{{ csrf_token }}'}});</script>
<script>
/*=====================[ Validate ]=====================*/
	$('#sale > form-group').on('submit', function (e) {

		$inputs.each(function () {
			let $input = $(this);
			if ($input .val() == "") {
				if ($input.attr('name') != 'phone' && $input.attr('name') != 'clerk') {
					alert($input.attr('placeholder') + '不能不填!');
					e.preventDefault();
					return false;
				}
			}
		});

		return true;
	});

	$('.validate-form').on('reset', function () {
		$('select:not(#input_clerk)  option').remove();
		$("<option></option>").text('MAU').appendTo('#input_color');
		$("<option></option>").text('size').appendTo('#input_size');
		$("<option></option>").text('count').appendTo('#input_count');
		$('select:not(#input_clerk)').attr("disabled","true");
    });

	$('.delete').click(function (e) {
		let check = confirm("確定刪除嗎?");
		if (check) {
			let $input = $(this);
			$.ajax({
				type: "POST",
				data: {
					number: $input.attr('name')
				},
				url: "{% url 'sold_today' %}",
				cache: false,
				dataType: "json",
				async: false,
			});
		}else{
			e.preventDefault();
			return false;
		}

		return true;
	})

	$('#input_product').on("input blur focus",function(){
		$.ajax({
			type: "POST",
			data: {
				product: $("#input_product").val(),
				type: "product"
			},
			url: "{% url 'sold_today' %}",
			cache: false,
			dataType: "json",
			async: false,
			success: function (result) {
				$('select:not(#input_clerk)').attr("disabled","true");
				if ($("#div_pdt").attr("class") == 'col-sm-2' || $("#div_color").attr("class") == 'col-sm-3') {
					$("#div_pdt").attr("class", 'col-sm-auto');
					$("#div_color").attr("class", 'col-sm-2');
				}
				if (result.repeat.length != 0) {
					$("#input_color option").remove();
					let color = $("#input_color");
					for(i = 0; i < result.repeat.length; i++){
						$("<option></option>").text(result.repeat[i]).appendTo(color);
						if (result.repeat[i].length > 9 && $("#div_pdt").attr("class") == 'col-sm-auto') {
							$("#div_pdt").attr("class", 'col-sm-2');
							$("#div_color").attr("class", 'col-sm-3');
						}
					}
					$('#input_color').removeAttr("disabled").removeClass('text-gray-500');
					colordate();
					sizedate();
				}
			},
		});
	})

	$('#input_color').change(function () {
		colordate();
		sizedate();
	})
	$('#input_size').change(function () {
		sizedate();
	})

	function colordate() {
		$.ajax({
			type: "POST",
			data: {
				product: $("#input_product").val(),
				color: $("#input_color :selected").text(),
				type: "color"
			},
			url: "{% url 'sold_today' %}",
			cache: false,
			dataType: "json",
			async: false,
			success: function (result) {
				$('#input_size').attr("disabled","true");
				if (result.repeat.length != 0) {
					$("#input_size option").remove();
					let size = $("#input_size");
					for(i = 0; i < result.repeat.length; i++){
						$("<option></option>").text(result.repeat[i]).appendTo(size);
					}
					$('#input_size').removeAttr("disabled").removeClass('text-gray-500');
					sizedate()
				} else {
					alert('沒找到商品2');
				}
			},
		});

	}

	function sizedate() {
		$.ajax({
			type: "POST",
			data: {
				product: $("#input_product").val(),
				color: $("#input_color :selected").text(),
				size:  $("#input_size :selected").text(),
				type: "count"
			},
			url: "{% url 'sold_today' %}",
			cache: false,
			dataType: "json",
			async: false,
			success: function (result) {
				$('#input_count').attr("disabled","true");
				if (result.repeat.length != 0) {
					$("#input_count option").remove();
					let count = $("#input_count");
					console.log(result.repeat)
					for(i = 0; i < result.repeat; i++){
						$("<option></option>").text(i+1).appendTo(count);
					}
					$('#input_count').removeAttr("disabled").removeClass('text-gray-500');
				} else {
					alert('沒找到商品3');
				}
			},
		});
	}

</script>
{% endblock %}

{% block tailjslink %}
<script src="{% static "vendor/bootstrap/js/bootstrap3-typeahead.min.js" %}"></script>
{% endblock %}